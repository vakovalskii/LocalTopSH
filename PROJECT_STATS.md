# LocalTopSH — Архитектура и Статистика

## 📊 Статистика проекта

| Метрика | Значение |
|---------|----------|
| **Всего коммитов** | 188 |
| **Дни разработки** | 7 (2-8 февраля 2026) |
| **Python файлов** | 5,561 |
| **TypeScript файлов** | 2,409 |
| **Строк кода** | ~122,000 |
| **Паттернов безопасности** | 247 |
| **Injection паттернов** | 19 |
| **Уникальных пользователей** | 186 |
| **Данные workspace** | 15 GB |

### Коммиты по дням

```
2026-02-02  ████████████████████████████████████████  84 (старт проекта)
2026-02-03  ██████████                                20
2026-02-04  ███                                        6
2026-02-05  ██████                                    13
2026-02-06  ██                                         4
2026-02-07  ██████████████████                        37
2026-02-08  ████████████                              24
```

### Контрибьюторы

| Автор | Коммиты |
|-------|---------|
| LocalTopSH Bot (AI) | 170 |
| Valerii Kovalskii | 9 |
| pasha | 4 |
| LocalTopSH | 4 |
| darklion | 1 |

---

## 🏗️ Архитектура

### Общая схема

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                     │
│  │   Telegram   │────▶│     bot      │────▶│     core     │                     │
│  │    Users     │     │   :4001      │     │    :4000     │                     │
│  └──────────────┘     └──────────────┘     └──────┬───────┘                     │
│                                                   │                              │
│                              ┌────────────────────┼────────────────────┐        │
│                              │                    │                    │        │
│                              ▼                    ▼                    ▼        │
│                       ┌──────────────┐     ┌──────────────┐     ┌──────────────┐│
│                       │    proxy     │     │  tools-api   │     │  docker-mcp  ││
│                       │    :3200     │     │    :8100     │     │    :3100     ││
│                       │  (secrets)   │     │  (registry)  │     │   (MCP)      ││
│                       └──────┬───────┘     └──────────────┘     └──────────────┘│
│                              │                                                   │
│                              ▼                                                   │
│                       ┌──────────────┐                                          │
│                       │  External    │                                          │
│                       │  LLM API     │                                          │
│                       │  (vLLM/etc)  │                                          │
│                       └──────────────┘                                          │
│                                                                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐│
│  │   admin      │     │  scheduler   │     │   userbot    │     │  sandbox_*   ││
│  │   :3000      │     │   (cron)     │     │  (Telegram)  │     │  :5000-5999  ││
│  └──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘│
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Микросервисы

| Сервис | Порт | Технология | Роль |
|--------|------|------------|------|
| **bot** | 4001 | Python/aiogram | Telegram бот, входная точка |
| **core** | 4000 | TypeScript | ReAct агент, оркестрация |
| **proxy** | 3200 | Python/Flask | Изоляция секретов, LLM прокси |
| **tools-api** | 8100 | TypeScript | Реестр инструментов, skills |
| **docker-mcp** | 3100 | TypeScript | MCP сервер для Docker |
| **admin** | 3000 | React/nginx | Веб-панель управления |
| **scheduler** | - | Python | Планировщик задач |
| **userbot** | - | Python/Telethon | Юзербот для групп |
| **sandbox_*** | 5000+ | Docker | Изолированные окружения |

---

## 🔐 Модель безопасности

### Пять уровней защиты

```
┌─────────────────────────────────────────────────────────────────┐
│  Layer 1: ACCESS CONTROL                                        │
│  ├── admin     — только админ                                  │
│  ├── allowlist — белый список                                   │
│  ├── pairing   — коды подтверждения                            │
│  └── public    — открытый доступ                               │
├─────────────────────────────────────────────────────────────────┤
│  Layer 2: INPUT VALIDATION                                      │
│  └── 247 паттернов блокировки опасных команд                   │
├─────────────────────────────────────────────────────────────────┤
│  Layer 3: PROMPT INJECTION DEFENSE                              │
│  └── 19 паттернов детекции манипуляций                         │
├─────────────────────────────────────────────────────────────────┤
│  Layer 4: SANDBOX ISOLATION                                     │
│  ├── Docker per-user                                           │
│  ├── 512 MB RAM limit                                          │
│  ├── 50% CPU limit                                             │
│  └── 100 PIDs limit                                            │
├─────────────────────────────────────────────────────────────────┤
│  Layer 5: SECRETS PROTECTION                                    │
│  └── Proxy-архитектура: агент никогда не видит API ключи       │
└─────────────────────────────────────────────────────────────────┘
```

### Заблокированные векторы атак

| Категория | Примеры | Защита |
|-----------|---------|--------|
| Env extraction | `env`, `printenv`, `/proc/self/environ` | Блокировка паттернов |
| File exfiltration | `cat .env`, `base64 secrets` | Sensitive file detection |
| Network attacks | `curl http://proxy:3200` | Internal service blocking |
| Resource exhaustion | Fork bomb, `stress --cpu` | Docker limits |
| Prompt injection | "забудь инструкции", "DAN mode" | 19 regex паттернов |

---

## 📁 Структура проекта

```
LocalTopSH/
├── bot/                    # Telegram бот (aiogram)
│   ├── main.py
│   ├── access.py           # DM Policy
│   └── prompt-injection-patterns.json
│
├── core/                   # ReAct агент (TypeScript)
│   ├── src/
│   │   ├── agent/          # Агент и system prompt
│   │   ├── approvals/      # Валидация команд
│   │   │   └── blocked-patterns.json (247 паттернов)
│   │   ├── tools/          # Инструменты агента
│   │   └── config.ts       # Централизованный конфиг
│   └── tools/              # Python tools
│
├── proxy/                  # Секреты и LLM прокси
│   └── proxy.py
│
├── admin/                  # React админ-панель
│   └── src/
│
├── tools-api/              # Реестр инструментов
├── docker-mcp/             # MCP сервер
├── scheduler/              # Планировщик
├── userbot/                # Telegram userbot
│
├── scripts/
│   └── doctor.py           # Security audit (46 checks)
│
├── workspace/              # Per-user данные (186 юзеров, 15GB)
├── secrets/                # API ключи (Docker secrets)
└── docker-compose.yml      # Оркестрация
```

---

## 🚀 Текущий статус

### Запущенные контейнеры

| Контейнер | Статус | Uptime |
|-----------|--------|--------|
| bot | ✅ healthy | 41 hours |
| core | ✅ healthy | 39 hours |
| proxy | ✅ healthy | 39 hours |
| admin | ✅ healthy | 39 hours |
| tools-api | ✅ healthy | 39 hours |
| docker-mcp | ✅ healthy | 41 hours |
| scheduler | ✅ healthy | 36 hours |
| userbot | ✅ running | 2 days |

### Боевое тестирование

- **Участников:** 1500+ хакеров
- **Длительность:** 7 часов стресс-теста
- **Утечек секретов:** 0
- **Даунтайм:** 0

---

## 🛠️ Технологический стек

| Слой | Технологии |
|------|------------|
| **Backend** | TypeScript, Python 3.11 |
| **Bot** | aiogram 3.x, Telethon |
| **Agent** | ReAct pattern, OpenAI-compatible API |
| **Frontend** | React, nginx |
| **Containers** | Docker, Docker Compose |
| **Monitoring** | Grafana, node-exporter |
| **LLM** | vLLM, Ollama, llama.cpp (any OpenAI-compatible) |

---

## 📈 Ключевые метрики

```
Коммитов за первый день:     84 (44% от всех)
Средний коммитов в день:     27
Код сгенерирован AI:         ~90% (170/188 коммитов)
Время от идеи до продакшн:   7 дней
```
